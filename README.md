## [최주호] 스프링 강의 - 스프링부트 인증 (Json Web Token)

### JWT

JWT (JSON Web Token)은 웹 표준 (RFC 7519)으로, 정보를 안전하게 전송하기 위한 표준이다.

JWT는 JSON 형식으로 데이터를 전송하며, 이 데이터는 서명 된 토큰으로 구성된다.

JWT는 인증과 권한 부여를 위해 사용된다.

사용자가 로그인하면 JWT가 생성되고, 이 JWT는 서버에서 유지되며, 매 요청마다 클라이언트에서 서버로 전송된다.

서버는 JWT를 검증하고 사용자의 권한을 확인한 후, 요청에 대한 응답을 반환한다.

JWT는 세 가지 부분으로 구성된다.

1. Header : 토큰의 유형과 서명에 사용되는 알고리즘을 지정하는 JSON 형식의 객체
2. Payload : 토큰에 저장되는 정보 (클레임)가 들어 있는 JSON 형식의 객체
3. Signature : Header와 Payload의 인코딩 값을 비밀 키로 서명하여 생성된 문자열

서버에서는 JWT의 서명을 검증하여 토큰이 유효한지 확인한다.

서명이 유효하지 않은 경우, 토큰이 변조되었거나 위조되었다는 것을 의미한다.

JWT는 특히 분산된 서비스 아키텍처에서 인증을 처리할 때 유용하다.

JWT를 사용하면 서비스 간에 인증을 공유할 수 있으며, 이는 더욱 유연하고 확장 가능한 시스템을 구축할 수 있도록 도와준다.

### JWT 사용 이유

JWT의 사용 이유는 다음과 같다.

1. 인증 정보 전달: JWT는 인증 정보를 포함한 토큰을 생성하고, 이를 전달하여 인증을 처리한다. 이를 통해 사용자가 로그인 인증을 한 번 거친 후, 이후 요청에서는 토큰만 전송하여 인증을 처리할 수 있다. 이는
   사용자가 매번 로그인 정보를 입력할 필요 없이, 더욱 편리한 인증 처리를 가능하게 한다.

2. 정보 안전성: JWT는 서명을 사용하여 정보를 안전하게 전송한다. 이를 통해 정보의 무결성을 보장하고, 데이터 변조나 위조를 방지한다. 서명이 있는 JWT는 클라이언트에서 변경하려고 시도해도 서버에서 검증할 때
   변경된 것으로 간주되어 유효하지 않게 된다.

3. 분산 시스템에서의 인증 처리: JWT는 분산된 시스템에서 인증 처리를 효과적으로 할 수 있다. 이는 서비스 간의 인증 정보 공유를 용이하게 하며, 여러 서비스에서 공통으로 사용할 수 있는 표준화된 방식을
   제공한다.

4. 확장성: JWT는 유연하고 확장 가능한 구조를 가지고 있다. 클레임을 추가하여 JWT에 더 많은 정보를 포함시킬 수 있으며, 토큰의 만료 시간을 설정할 수 있다. 이는 보안성과 편의성을 더욱 향상시켜 준다.
   따라서 JWT는 정보의 안전성과 분산 시스템에서의 인증 처리를 간편하게 할 수 있어, 인증 처리에 유용하게 사용된다.

### JWT 인증 서버 동작 방식

- 클라이언트는 서버에 인증을 요청한다
- 서버는 사용자 정보를 확인하고, 맞으면 JWT를 생성한다.
- response header에 Authorization 키값에 Bearer JWT 방식으로 토큰을 담아서 응답한다.
- 이것을 Bearer 인증 방식이라고 한다.
- 클라이언트는 JWT 토큰을 클라이언트 측 애플리케이션에 저장한다. (localstorage, sessionstorage, Cookie, KeyStore, Keychain)
- 클라이언트는 서버쪽 인증 자원을 요청할 때마다, 토큰을 헤더에 싫어서 요청한다

> Bearer 인증 방식은 웹 서비스와 API에 대한 인증 및 권한 부여를 제공하는 일반적인 방법이다. 이 방식은
OAuth 2.0 인증 프레임워크에서 사용되며, 사용자의 자격 증명을 대신하여 클라이언트와 서버 사이에 액세스
토큰(Access Token)을 전달하는데 사용된다.
> Bearer 인증 방식의 주요 개념은 다음과 같다:
> 
> 1. 클라이언트는 사용자의 자격 증명을 사용하여 인증 서버에 인증을 요청한다.
> 2. 인증 서버는 클라이언트의 자격 증명을 확인하고, 올바른 경우 액세스 토큰을 발급한다.
> 3. 클라이언트는 이 액세스 토큰을 사용하여 API에 요청을 보낼 때 인증 헤더에 포함시킨다. 일반적으로 `Authorization: Bearer {access_token}` 형식으로 전달된다.
> 4. API 서버는 액세스 토큰의 유효성을 검사하고, 요청이 유효한 경우 적절한 데이터를 반환한다. Bearer 인증 방식의 주요 장점은 사용자의 자격 증명을 직접 전달하는 대신 액세스 토큰을 사용하여 인증 및 권한 부여를 처리한다는 것이다. 이 방식은 API를 사용하는 다양한 클라이언트에 대한 인증을 간소화하고, 각 클라이언트에 대한 권한을 조절할 수 있다. 그러나 Bearer 인증 방식의 주요 단점은 액세스 토큰이 탈취되면 해당 토큰을 사용하여 악의적인 요청을 보낼 수 있다는 것이다. 따라서 이 방식을 사용할 때는 HTTPS와 같은 안전한 프로토콜을 사용하여 토큰의 유출을 방지하는 것이 중요하다. 또한, 토큰의 만료 시간을 짧게 설정하여 토큰의 유효 기간을 제한하는 것도 좋은 방법이다.

### 상태가 없는 JWT 서버

스프링 시큐리티에서 JWT를 사용하게 되면, 일반적으로 csrf.disable()을 설정하는 이유는 다음과 같다:

1. Stateless 인증: JWT 인증은 stateless한 인증 방식이다. 이는 서버가 사용자의 세션 상태를 추적하거나 저장하지 않는다는 뜻이다. 그러나 CSRF 공격을 방어하기 위해 사용되는 CSRF 토큰은 일반적으로 세션을 기반으로 한다. 따라서 JWT를 사용할 때 세션 기반의 CSRF 토큰을 사용하는 것은 일반적이지 않다.

2. CORS 정책과 요청 헤더: JWT 인증을 사용하는 애플리케이션에서는 보통 CORS 정책을 설정하고, 사용자 정의 요청 헤더를 검사하는 방법으로 CSRF 공격을 방어한다. 이러한 방법으로 충분한 보안을 제공할 수 있기 때문에, 추가적으로 CSRF 토큰을 사용할 필요가 없다.

3. 헤더 기반 인증: JWT 인증은 클라이언트가 매 요청마다 JWT를 요청 헤더에 포함시켜 서버에 전송하는 방식으로 동작한다. 이 헤더는 보통 공격자가 다른 사이트에서 요청을 보낼 때 손쉽게 조작할 수 없다. 따라서, JWT를 사용하는 경우 CSRF 공격에 대한 위험이 상대적으로 낮다. 이러한 이유로 인해, 스프링 시큐리티에서 JWT 인증을 사용할 경우 `csrf.disable()`을 설정하는 것이 일반적이다. 하지만, 이러한 설정이 모든 경우에 적합하지는 않으며, 웹 애플리케이션의 요구사항에 따라 적절한 보안 설정을 선택해야 한다.

### Refresh Token

JWT를 앱과 리액트에서 사용하는 서버를 구축하려면, 일반적으로 다음과 같은 방법을 사용할 수 있다.

이 예에서는 jsession을 사용하지 않고, JWT를 HttpOnly 쿠키로 관리하는 방법을 설명한다.

1. 액세스 토큰 발급: 클라이언트가 인증 정보(이메일, 비밀번호 등)를 전송하면, 서버는 인증 정보를 확인하고, JWT 액세스 토큰 `Authorization`에 발급한다.

2. 리프레시 토큰 발급: 동시에 서버는 JWT 리프레시 토큰을 발급하고, 이 토큰을 `HttpOnly` 속성의 쿠키로 클라이언트에 전송한다. 이렇게 하면, 클라이언트의 스크립트는 리프레시 토큰에 접근할 수 없으므로, XSS 공격으로부터 보호된다.

3. 액세스 토큰 저장: 액세스 토큰은 웹 브라우저의 메모리에 저장하거나, 로컬 스토리지에 저장할 수 있다. 모바일 앱에서는 안전한 저장소(예: Android의 KeyStore, iOS의 Keychain)를 사용하여 액세스 토큰을 저장한다.

4. 액세스 토큰 사용: 클라이언트는 API 요청 시 액세스 토큰을 인증 헤더에 포함시켜 전송한다(`Authorization: Bearer {access_token}`). 서버는 액세스 토큰의 유효성을 검사하고, 요청을 처리한다.

5. 액세스 토큰 만료 및 리프레시: 액세스 토큰이 만료되면, 클라이언트는 `HttpOnly` 쿠키로 저장된 리프레시 토큰을 사용하여 새로운 액세스 토큰을 요청한다. 서버는 리프레시 토큰의 유효성을 검사하고, 새로운 액세스 토큰을 발급한다.

6. 로그아웃: 사용자가 로그아웃하면, 클라이언트는 액세스 토큰을 삭제하고, 서버에 로그아웃 요청을 보낸다. 서버는 리플래시 토큰을 삭제한다.

AccessToken의 유효시간을 짧게하고, RefreshToken의 유효시간을 길게 한다.

### JWT 보안 취약점

- AccessToken 탈취 - 시간을 짧게 설정한다.
- RefreshToken 탈취 (탈취를 못하게 막거나, 탈취당하더라도 사용하지 못하게 해야함)

> 1. HttpOnly 쿠키 사용: RefreshToken을 HttpOnly 쿠키에 저장하면 클라이언트 스크립트가 쿠키에 직접 접근할 수 없어 XSS 공격으로부터 보호할 수 있다.
> 2. Secure 쿠키 사용: Secure 쿠키를 사용하면 HTTPS를 통해서만 쿠키가 전송되므로, 중간자 공격(MITM)으로부터 보호된다.
> 3. SameSite 쿠키 속성 설정: SameSite 속성을 설정하여 CSRF 공격으로부터 보호할 수 있다. SameSite 속성은 쿠키가 동일한 사이트에서만 전송되도록 제한한다.
> 4. IP 주소 확인: 서버에서 RefreshToken을 발급할 때, 사용자의 IP 주소를 기록하고, 토큰 갱신 요청이 있을때마다 IP 주소를 확인하여, 이상한 접근을 감지할 수 있다. 이 방법은 일부 환경에서는 제한적일 수 있다(예: 동적 IP 사용).
> 5. RefreshToken의 짧은 유효기간 설정: RefreshToken의 유효기간을 짧게 설정하여, 탈취된 경우에도 영향을 최소화할 수 있다.
> 6. 사용자 기기 정보 저장 및 검증: RefreshToken을 발급할 때 사용자의 기기 정보를 저장하고, 토큰 갱신 요청 시 기기 정보를 검증하여, 이상한 접근을 차단할 수 있다.
> 7. 토큰 사용 횟수 제한: RefreshToken의 사용 횟수를 제한하여, 토큰이 탈취되어 사용되는 것을 감지하고 차단할 수 있다.
> 8. 토큰 회수 및 무효화 기능 구현: 사용자가 비정상적인 접근이나 토큰 탈취를 감지하면, 서버에서 해당 토큰을 무효화하고 회수할 수 있는 기능을 구현한다.
> 위와 같은 방법들을 사용하여 RefreshToken이 탈취되는 것을 방지하거나, 영향을 최소화할 수 있다. 가능한 한 여러 가지 방법을 조합하여 더 강력한 보안을 제공하는 것이 좋다.
